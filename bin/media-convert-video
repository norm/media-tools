#!/bin/bash

set -e

function get_audio_streams {
    local input="$1"

    HandBrakeCLI -i "$input" -t0 2>&1 \
        | awk '/audio tracks/{flag=1; next} !/    \+ /{flag=0} flag'
}

function get_stream_keywords {
    local stream="$1"

    echo "$stream" | perl -ne '
        s{
            ^ .*
            \( (.*?) \) \s+
            \( (.*?) \s+ ch \) \s+
            \( iso639-2: \s+ (\w+) \)
            .* $
        }{\1 \2 \3}x;
        print;
    '
}

function get_audio_arguments {
    local input="$1"

    local streams=$( get_audio_streams "$input" | wc -l | tr -d ' ' )
    if [ "$streams" -ne 1 ]; then
        echo >&2 'Can only convert sources with one audio stream.'
        exit 1
    fi

    echo '--audio 1'

    streams=$( get_audio_streams "$input" )
    read -r quality channel language < <( get_stream_keywords "$streams" )

    if [ "$quality" = 'AC3' ]; then
        echo '--ab 640 --mixdown 6ch --arate Auto --aencoder copy:ac3'
    elif [ "$quality" = 'DTS' ]; then
        echo '--ab 640 --mixdown 6ch --arate Auto --aencoder copy:dts'
    elif [ "$quality" = 'AAC' ]; then
        echo '--ab 640 --mixdown 6ch --arate Auto --aencoder copy:aac'
    elif [ "$quality" = 'MP3' ]; then
        if [ "$channel" = '2.0' ]; then
            echo '--ab 160 --mixdown stereo --arate 48 --aencoder ca_aac'
        elif [ "$channel" = '1.0' ]; then
            echo '--ab 80 --mixdown momo --arate 48 --aencoder ca_aac'
        else
            echo >&2 'Unknown audio type:'
            echo >&2 "quality=$quality"
            echo >&2 "channel=$channel"
            echo >&2 "language=$language"
            exit 1
        fi
    else
        echo >&2 'Unknown audio type:'
        echo >&2 "quality=$quality"
        echo >&2 "channel=$channel"
        echo >&2 "language=$language"
        exit 1
    fi
}

function media_convert_video {
    local input="$1"
    local output="$2"
    local track="${3:-1}"

    local -a handbrake_args

    handbrake_args+=($( get_audio_arguments "$input" ))

    # no more than 1080p
    handbrake_args+=('--maxWidth' '1920')
    handbrake_args+=('--maxHeight' '1080')

    # loose anamorphic pictures
    handbrake_args+=('--loose-anamorphic')
    handbrake_args+=('--modulus' '2')

    # auto crop detection is sometimes wrong, so never crop
    handbrake_args+=('--crop' '0:0:0:0')

    # deinterlace if needed
    handbrake_args+=('--decomb' 'fast')

    # use source frame rate, except clip at 30
    handbrake_args+=('--rate' '30')
    handbrake_args+=('--pfr')

    # prefer slower transforms for higher quality output
    handbrake_args+=('--quality' '22')
    handbrake_args+=('--x264-preset' 'slow')
    handbrake_args+=('--h264-profile' 'high')
    handbrake_args+=('--h264-level' '4.1')

    # x264 encoded mp4 files
    handbrake_args+=('--format' 'mp4')
    handbrake_args+=('--encoder' 'x264')
    handbrake_args+=('--encopts' 'b-adapt=2')

    # preserve chapter markers if in source
    handbrake_args+=('--markers')

    HandBrakeCLI \
        "${handbrake_args[@]}"      \
        -i "$input"                 \
        -t "$track"                 \
        -o "$output"

}


if [ "$0" = "$BASH_SOURCE" ]; then
    media_convert_video "$@"
fi
