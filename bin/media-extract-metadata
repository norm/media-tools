#!/bin/bash

set -e

# shellcheck source=/dev/null
source $(which media)
summary_line "$*" 'extract metadata from a directory name'


function media_extract_metadata {
    local escaped

    escaped="$(
        echo "$1" \
            | sed -e 's/\$/\\$/' -e 's/@/\\@/'
    )"

    perl -E "
        sub quote_string {
            my \$string = shift;
            \$string =~ s/\\\$/\\\\\\\$/g;
            \$string =~ s/\"/\\\\\"/g;
            return qq(\"\$string\");
        }

        my \$extract = qq($escaped);

        # strip trailing slashes
        \$extract =~ s{/$}{};

        # strip everything but the last dir
        \$extract =~ s{ ^ .*?/ ([^/]+) $}{\1}x;

        \$extract =~ m{
            ^
            (?<series> .* )
            \s+ - \s+
            (?<season> \d+ )
            x
            (?<episode> \d+ )
            \s+ - \s+
            (?<title> .* )
            $
        }x;

        if (defined $+{'series'}) {
            say join ' ',
                '--TVShowName=' . quote_string($+{'series'}),
                '--TVSeasonNum=' . $+{'season'},
                '--TVEpisodeNum=' . $+{'episode'},
                '--title=' . quote_string($+{'title'}),
                '--stik=' . quote_string('TV Show'),
        }
        else {
            say qq(Error: unknown format '\$extract');
        }
";
}


media_extract_metadata "$1"
