#!/bin/bash

set -e

# shellcheck source=/dev/null
source "$(which media)"
summary_line "$*" 'convert and add new media to iTunes library'


function clean_up_converted {
    local -r dir="$1"
    local -r video="$2"

    if [ -n "$TRASH_DIR" ]; then
        mkdir -p "$TRASH_DIR"
        mv "$video" "$TRASH_DIR"
        rm -f \
            "$dir/poster.jpg" "$dir/"poster-resized-*.jpg \
            "$dir/poster.png" "$dir/"poster-resized-*.png \
            "$dir/.DS_Store"

        # don't exit (because of `set -e`) if we haven't cleaned all the
        # contents out (that's not an error worth stopping for)
        rmdir "$dir" \
            || true
    fi
}

function convert_and_add_tv {
    local -r dir="$1"
    local -r video="$2"

    local -r file=$( basename "$video" )
    local -r output="${CONVERT_DIR}/media_conversion_${file%.*}.m4v"

    media-convert-video "$video" "$output"

    eval media-tag-video "$output" "$( media-extract-metadata "$dir" )"

    [ -f "$dir/poster.jpg" ] && media-set-poster "$output" "$dir/poster.jpg"
    [ -f "$dir/poster.png" ] && media-set-poster "$output" "$dir/poster.png"

    path=$( eval media-install "$output" )
    [ -z "$IGNORE_ITUNES" ] \
        && media-itunes-add "$path"

    clean_up_converted "$dir" "$video"
}


for directory in "$@"; do
    video=$(
        # shellcheck disable=SC2012
        ls "$directory"/*.{m4v,avi,mkv,mp4,mpg,wmv,vob,m2ts,xvid} \
            2>/dev/null \
                || true     # not all files will exist, not an error
    )
    count=$(
        # shellcheck disable=SC2012
        ls "$directory"/*.{m4v,avi,mkv,mp4,mpg,wmv,vob,m2ts,xvid} \
            2>/dev/null \
                | wc -l \
                | tr -d ' '
    )

    case $count in
        0)  media_error "\"$directory\" has no known video content."
            ;;
        1)  convert_and_add_tv "$directory" "$video"
            ;;
        *)  media_error "\"$directory\" has multiple video files."
            ;;
    esac
done
