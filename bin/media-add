#!/bin/bash

set -e
source $(which media)


function convert_and_add_tv {
    local dir="$1"
    local video="$2"

    local file=$( basename "$video" )
    local output="${CONVERT_DIR}/media_conversion_${file%.*}.m4v"

    media-convert-video "$video" "$output"

    eval media-tag-video "$output" $( media-extract-metadata "$dir" )

    [ -f "$dir/poster.jpg" ] && media-set-poster "$output" "$dir/poster.jpg"
    [ -f "$dir/poster.png" ] && media-set-poster "$output" "$dir/poster.png"

    path=$( eval media-install "$output" )
}

for directory in "$@"; do
    video=$(
        ls "$directory"/*.{m4v,avi,mkv,mp4,mpg,wmv,vob,m2ts,xvid} \
            2>/dev/null \
                || true     # not all files will exist, not an error
    )
    count=$(
        ls "$directory"/*.{m4v,avi,mkv,mp4,mpg,wmv,vob,m2ts,xvid} \
            2>/dev/null \
                | wc -l \
                | tr -d ' '
    )

    case $count in
        0)  media_error \"$directory\" has no known video content.
            ;;
        1)  convert_and_add_tv "$directory" "$video"
            ;;
        *)  media_error \"$directory\" has multiple video files.
            ;;
    esac
done
